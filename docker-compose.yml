# ============================================================================
# Docker Compose for Speed-Run AML Platform
# Full-stack application with backend, frontend, database, and cache
# ============================================================================

version: '3.8'

services:
  # ==========================================================================
  # PostgreSQL Database
  # ==========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: speedrun-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-speedrun_aml}
      POSTGRES_USER: ${POSTGRES_USER:-speedrun}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-speedrun}
      POSTGRES_INITDB_ARGS: "-E UTF8"
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/database/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-speedrun} -d ${POSTGRES_DB:-speedrun_aml}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - speedrun-network
    restart: unless-stopped

  # ==========================================================================
  # Redis Cache
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: speedrun-redis
    command: redis-server --maxmemory ${REDIS_MAX_MEMORY:-2gb} --maxmemory-policy allkeys-lru --save 60 1 --loglevel warning
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - speedrun-network
    restart: unless-stopped

  # ==========================================================================
  # FastAPI Backend
  # ==========================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: speedrun-backend
    environment:
      # Application Settings
      APP_NAME: ${APP_NAME:-Speed-Run AML Platform}
      VERSION: ${VERSION:-1.0.0}

      # Database Configuration
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-speedrun}:${POSTGRES_PASSWORD:-speedrun}@postgres:5432/${POSTGRES_DB:-speedrun_aml}
      DB_POOL_SIZE: ${DB_POOL_SIZE:-20}
      DB_MAX_OVERFLOW: ${DB_MAX_OVERFLOW:-10}
      DB_ECHO: ${DB_ECHO:-false}
      TESTING: ${TESTING:-false}

      # Redis Configuration
      REDIS_URL: redis://redis:6379/0
      REDIS_MAX_CONNECTIONS: ${REDIS_MAX_CONNECTIONS:-50}
      REDIS_SOCKET_TIMEOUT: ${REDIS_SOCKET_TIMEOUT:-5}
      REDIS_SOCKET_CONNECT_TIMEOUT: ${REDIS_SOCKET_CONNECT_TIMEOUT:-5}
      CACHE_ENABLED: ${CACHE_ENABLED:-true}
      CACHE_DEFAULT_TTL: ${CACHE_DEFAULT_TTL:-3600}

      # CORS Settings
      ALLOWED_ORIGINS: '["http://localhost:3000","http://localhost:5173","http://frontend:3000"]'

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FILE: ${LOG_FILE:-}

      # File Upload
      MAX_FILE_SIZE: ${MAX_FILE_SIZE:-10485760}
      UPLOAD_DIR: ${UPLOAD_DIR:-/tmp/uploads}
      ALLOWED_EXTENSIONS: '${ALLOWED_EXTENSIONS:-[".pdf",".png",".jpg",".jpeg",".tiff",".bmp",".docx"]}'

      # OCR Settings
      OCR_ENGINE: ${OCR_ENGINE:-docling}
      OCR_LANGUAGE: ${OCR_LANGUAGE:-en}

      # Corroboration Settings
      AUDIT_LOG_PATH: ${AUDIT_LOG_PATH:-/tmp/corroboration_audit}
      ENABLE_REVERSE_IMAGE_SEARCH: ${ENABLE_REVERSE_IMAGE_SEARCH:-false}
      ENABLE_ADVANCED_FORENSICS: ${ENABLE_ADVANCED_FORENSICS:-true}

      # External API Keys (Optional)
      GOOGLE_VISION_API_KEY: ${GOOGLE_VISION_API_KEY:-}
      TINEYE_API_KEY: ${TINEYE_API_KEY:-}
      TINEYE_API_SECRET: ${TINEYE_API_SECRET:-}
      BING_VISUAL_SEARCH_KEY: ${BING_VISUAL_SEARCH_KEY:-}
      HIVE_AI_API_TOKEN: ${HIVE_AI_API_TOKEN:-}
      SIGHTENGINE_API_USER: ${SIGHTENGINE_API_USER:-}
      SIGHTENGINE_API_SECRET: ${SIGHTENGINE_API_SECRET:-}

      # Risk Scoring Thresholds
      RISK_THRESHOLD_LOW: ${RISK_THRESHOLD_LOW:-25.0}
      RISK_THRESHOLD_MEDIUM: ${RISK_THRESHOLD_MEDIUM:-50.0}
      RISK_THRESHOLD_HIGH: ${RISK_THRESHOLD_HIGH:-75.0}

      # Tampering Detection Thresholds
      TAMPERING_ELA_ANOMALY_THRESHOLD: ${TAMPERING_ELA_ANOMALY_THRESHOLD:-0.15}
      TAMPERING_ELA_VERY_LOW: ${TAMPERING_ELA_VERY_LOW:-15.0}
      TAMPERING_ELA_LOW: ${TAMPERING_ELA_LOW:-40.0}
      TAMPERING_ELA_HIGH: ${TAMPERING_ELA_HIGH:-600.0}
      TAMPERING_ELA_VERY_HIGH: ${TAMPERING_ELA_VERY_HIGH:-1000.0}
      TAMPERING_NOISE_RATIO_MAX: ${TAMPERING_NOISE_RATIO_MAX:-3.0}
      TAMPERING_EDGE_CONSISTENCY_DIFF: ${TAMPERING_EDGE_CONSISTENCY_DIFF:-20}
      TAMPERING_RESAMPLING_FFT_PEAK_RATIO: ${TAMPERING_RESAMPLING_FFT_PEAK_RATIO:-8.0}
      TAMPERING_COLOR_CORR_LOW: ${TAMPERING_COLOR_CORR_LOW:-0.85}
      TAMPERING_MEDIAN_FILTER_THRESHOLD: ${TAMPERING_MEDIAN_FILTER_THRESHOLD:-1.0}
      TAMPERING_CLONE_REGION_SIZE: ${TAMPERING_CLONE_REGION_SIZE:-32}
      TAMPERING_CLONE_DUPLICATE_RATIO_THRESHOLD: ${TAMPERING_CLONE_DUPLICATE_RATIO_THRESHOLD:-0.05}
      TAMPERING_CLONE_DISTANCE_MIN_BLOCKS: ${TAMPERING_CLONE_DISTANCE_MIN_BLOCKS:-2}
      TAMPERING_COMPRESSION_VARIANCE_THRESHOLD: ${TAMPERING_COMPRESSION_VARIANCE_THRESHOLD:-1000.0}

      # Risk Score Normalization
      RISK_NORMALIZATION_REDUCTION_LOW: ${RISK_NORMALIZATION_REDUCTION_LOW:-0.4}
      RISK_NORMALIZATION_REDUCTION_MEDIUM: ${RISK_NORMALIZATION_REDUCTION_MEDIUM:-0.5}
      RISK_NORMALIZATION_REDUCTION_HIGH: ${RISK_NORMALIZATION_REDUCTION_HIGH:-0.65}
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    volumes:
      - ./backend/src:/app/src:ro
      - backend_uploads:/tmp/uploads
      - backend_audit:/tmp/corroboration_audit
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - speedrun-network
    restart: unless-stopped

  # ==========================================================================
  # Next.js Frontend
  # ==========================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_BACKEND_URL: ${NEXT_PUBLIC_BACKEND_URL:-http://backend:8000}
        NEXT_PUBLIC_API_VERSION: ${NEXT_PUBLIC_API_VERSION:-v1}
    container_name: speedrun-frontend
    environment:
      # API Configuration
      NEXT_PUBLIC_BACKEND_URL: ${NEXT_PUBLIC_BACKEND_URL:-http://localhost:8000}
      NEXT_PUBLIC_API_VERSION: ${NEXT_PUBLIC_API_VERSION:-v1}
      NEXT_PUBLIC_API_TIMEOUT: ${NEXT_PUBLIC_API_TIMEOUT:-30000}
      NEXT_PUBLIC_API_RETRY_ATTEMPTS: ${NEXT_PUBLIC_API_RETRY_ATTEMPTS:-3}

      # Feature Flags
      NEXT_PUBLIC_USE_BACKEND_API: ${NEXT_PUBLIC_USE_BACKEND_API:-true}
      NEXT_PUBLIC_ENABLE_DOCUMENT_UPLOAD: ${NEXT_PUBLIC_ENABLE_DOCUMENT_UPLOAD:-true}
      NEXT_PUBLIC_ENABLE_AI_DETECTION: ${NEXT_PUBLIC_ENABLE_AI_DETECTION:-true}
      NEXT_PUBLIC_ENABLE_FORENSIC_ANALYSIS: ${NEXT_PUBLIC_ENABLE_FORENSIC_ANALYSIS:-true}
      NEXT_PUBLIC_ENABLE_REVERSE_IMAGE_SEARCH: ${NEXT_PUBLIC_ENABLE_REVERSE_IMAGE_SEARCH:-false}
      NEXT_PUBLIC_ENABLE_REALTIME_ALERTS: ${NEXT_PUBLIC_ENABLE_REALTIME_ALERTS:-true}
      NEXT_PUBLIC_ENABLE_KANBAN_BOARD: ${NEXT_PUBLIC_ENABLE_KANBAN_BOARD:-true}

      # UI Configuration
      NEXT_PUBLIC_APP_NAME: ${NEXT_PUBLIC_APP_NAME:-Speed-Run AML Platform}
      NEXT_PUBLIC_APP_VERSION: ${NEXT_PUBLIC_APP_VERSION:-1.0.0}
      NEXT_PUBLIC_ITEMS_PER_PAGE: ${NEXT_PUBLIC_ITEMS_PER_PAGE:-10}
      NEXT_PUBLIC_AUTO_REFRESH_INTERVAL: ${NEXT_PUBLIC_AUTO_REFRESH_INTERVAL:-30000}
      NEXT_PUBLIC_MAX_FILE_SIZE: ${NEXT_PUBLIC_MAX_FILE_SIZE:-10485760}
      NEXT_PUBLIC_ALLOWED_FILE_TYPES: ${NEXT_PUBLIC_ALLOWED_FILE_TYPES:-.pdf,.png,.jpg,.jpeg,.tiff,.bmp,.docx}

      # Development Settings
      NEXT_PUBLIC_DEBUG: ${NEXT_PUBLIC_DEBUG:-false}
      NEXT_PUBLIC_ENABLE_DEV_TOOLS: ${NEXT_PUBLIC_ENABLE_DEV_TOOLS:-false}
      NEXT_PUBLIC_LOG_API_CALLS: ${NEXT_PUBLIC_LOG_API_CALLS:-false}
      NEXT_PUBLIC_SHOW_PERFORMANCE_METRICS: ${NEXT_PUBLIC_SHOW_PERFORMANCE_METRICS:-false}

      # Authentication
      NEXT_PUBLIC_ENABLE_AUTH: ${NEXT_PUBLIC_ENABLE_AUTH:-false}
      NEXT_PUBLIC_SESSION_TIMEOUT: ${NEXT_PUBLIC_SESSION_TIMEOUT:-30}
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - speedrun-network
    restart: unless-stopped

  # ==========================================================================
  # Optional: PostgreSQL Admin UI (pgAdmin)
  # ==========================================================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: speedrun-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@speedrun.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - speedrun-network
    profiles:
      - tools  # Only start with: docker-compose --profile tools up
    restart: unless-stopped

  # ==========================================================================
  # Optional: Redis Commander (Redis UI)
  # ==========================================================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: speedrun-redis-commander
    environment:
      REDIS_HOSTS: local:redis:6379
    ports:
      - "${REDIS_COMMANDER_PORT:-8081}:8081"
    depends_on:
      - redis
    networks:
      - speedrun-network
    profiles:
      - tools  # Only start with: docker-compose --profile tools up
    restart: unless-stopped

# ============================================================================
# Volumes
# ============================================================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  pgadmin_data:
    driver: local
  backend_uploads:
    driver: local
  backend_audit:
    driver: local

# ============================================================================
# Networks
# ============================================================================
networks:
  speedrun-network:
    driver: bridge
